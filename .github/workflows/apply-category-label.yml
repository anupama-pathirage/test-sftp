name: Auto-label Task Category

on:
  issues:
    types: [opened, edited, labeled]

permissions:
  issues: write

jobs:
  label_task_category:
    runs-on: ubuntu-latest
    steps:
      - name: Apply Task/* label based on Task Category
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            if (!issue) return;

            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = issue.number;

            const labels = (issue.labels || []).map(l => (typeof l === "string" ? l : l.name));

            const body = issue.body || "";

            // Issue Forms render fields like:
            // ### Task Category
            // Refactoring
            //
            // We'll extract the line right after the heading.
            function extractFieldValue(heading) {
              const re = new RegExp(`###\\s+${heading}\\s*\\n+([^\\n#]+)`, "i");
              const match = body.match(re);
              return match ? match[1].trim() : null;
            }

            const category = extractFieldValue("Task Category");
            if (!category) {
              core.info("Could not find 'Task Category' in issue body. Skipping.");
              return;
            }

            // Map dropdown text -> label
            const categoryToLabel = {
              "Research / Proposal": "Task/Research",
              "Implementation": "Task/Implementation",
              "Testing": "Task/Testing",
              "Refactoring": "Task/Refactoring",
              "Documentation": "Task/Documentation",
              "CI/CD Update": "Task/CICD",
              "Dependency Upgrade": "Task/DependencyUpgrade",
              "Other": "Task/Other"
            };

            const desiredLabel = categoryToLabel[category];
            if (!desiredLabel) {
              core.info(`No mapping found for category: '${category}'. Skipping.`);
              return;
            }

            // Remove any existing Task/* labels first (optional but recommended)
            const taskPrefix = "Task/";
            const existingTaskLabels = labels.filter(l => l && l.startsWith(taskPrefix));

            // If the correct label is already present, no-op
            if (labels.includes(desiredLabel)) {
              core.info(`Label '${desiredLabel}' already applied. Done.`);
              return;
            }

            // Remove old Task/* labels (keep Type/Task)
            for (const l of existingTaskLabels) {
              try {
                await github.rest.issues.removeLabel({
                  owner,
                  repo,
                  issue_number,
                  name: l
                });
                core.info(`Removed label: ${l}`);
              } catch (e) {
                // If label doesn't exist or already removed, ignore
                core.info(`Could not remove label '${l}': ${e.message}`);
              }
            }

            // Add desired Task/* label
            await github.rest.issues.addLabels({
              owner,
              repo,
              issue_number,
              labels: [desiredLabel]
            });

            core.info(`Applied label: ${desiredLabel}`);