name: Auto-label Task Category and Team

on:
  issues:
    types: [opened, edited, labeled]

permissions:
  issues: write

jobs:
  label_task_and_team:
    runs-on: ubuntu-latest
    steps:
      - name: Apply Task/* and Team/* labels
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            if (!issue) return;

            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = issue.number;

            const labels = (issue.labels || []).map(l => (typeof l === "string" ? l : l.name));

            const body = issue.body || "";

            function extractFieldValue(heading) {
              const re = new RegExp(`###\\s+${heading}\\s*\\n+([^\\n#]+)`, "i");
              const match = body.match(re);
              return match ? match[1].trim() : null;
            }

            const taskCategory = extractFieldValue("Task Category");
            const teamValue = extractFieldValue("Team");

            core.info("Values=========");
            core.info(`Task Category: ${taskCategory}`);

            const taskMapping = {
              "Research / Proposal": "Task/Research",
              "Implementation": "Task/Implementation",
              "Testing": "Task/Testing",
              "Refactoring": "Task/Refactoring",
              "Documentation": "Task/Documentation",
              "CI/CD Update": "Task/CICD",
              "Dependency Upgrade": "Task/DependencyUpgrade",
              "Other": "Task/Other"
            };

            const teamMapping = {
              "Integration": "Team/Integration",
              "AI": "Team/AI",
              "MI": "Team/MI",
              "ICP/Central/Observability": "Team/ICP",
              "Cloud": "Team/Cloud",
              "Integrator-Editor": "Team/Editor",
              "Ballerina": "Team/Ballerina",
              "Connectors": "Team/Connectors",
              "SI": "Team/SI"
            };

            async function updateLabel(prefix, desiredLabel) {
              if (!desiredLabel) return;

              const existing = labels.filter(l => l && l.startsWith(prefix));

              // Remove old labels with same prefix
              for (const l of existing) {
                if (l !== desiredLabel) {
                  try {
                    await github.rest.issues.removeLabel({
                      owner,
                      repo,
                      issue_number,
                      name: l
                    });
                    core.info(`Removed label: ${l}`);
                  } catch (e) {
                    core.info(`Could not remove ${l}: ${e.message}`);
                  }
                }
              }

              // Add desired label if missing
              if (!labels.includes(desiredLabel)) {
                await github.rest.issues.addLabels({
                  owner,
                  repo,
                  issue_number,
                  labels: [desiredLabel]
                });
                core.info(`Applied label: ${desiredLabel}`);
              }
            }

            const desiredTaskLabel = taskMapping[taskCategory];
            const desiredTeamLabel = teamMapping[teamValue];

            await updateLabel("Task/", desiredTaskLabel);
            await updateLabel("Team/", desiredTeamLabel);

            core.info("Label automation completed.");